
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Status Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }

      #container #loading-text{
        display: none;
      }

      #container.loading #loading-text{
        display: block;
      }

      table {
        border: 1px solid #000;
        margin-bottom: 20px;
        width: 100%;
      }

      td {
        border: 1px solid black;
        padding: 3px;
        width: 11%;
      }

      #status-template {
        display: none;
      }

      td.header{
        background-color: gray;
        color: white;
      }

      td.open {
        background-color: #336699;
        color: white;
      }

      td.in-progress, td.resolved, td.reopened{
        background-color: yellow;
      }

      td.closed{
        background-color: green;
      }
    </style>
    <link href="/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Release Dashboard</a>
          <div class="nav-collapse">
            <ul class="nav">
            </ul>
            <p class="navbar-text pull-right">
              <a href="/logout" style="color:white">Log-out</a>
            </p>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div id="container" class="container">
      <h1 id="loading-text"><img src="/images/ajax-loader.gif"/> <span class="text">Loading 0%</span></h1>
    </div> <!-- /container -->

    <div id="status-template">
      <table class="status-root">
        <tr>
          <td class='header'>Activity</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class='header'>Assignee</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class='header'>Due Date</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td class='header'>Status</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </table>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script>
      RD = {};
      RD.releases = [];
      RD.issues = {};

      RD.cssify = function(str){
        return str.toLowerCase().replace(/\W/g, '-');
      }

      RD.indexIssues = function(){
        $(RD.data.issues).each(function(index, issue){
          RD.issues[issue.key] = issue;
        });
      }

      RD.findReleases = function(){
        var issue;
        for(var key in RD.issues){
          issue = RD.issues[key];
          if(issue.fields.parent == null &&
             issue.fields.summary.match(/release template/ig) == null){
            RD.releases.push(issue);
            console.log(issue);
          }
        }
      }

      RD.processData = function(){
        RD.indexIssues();
        if(RD.dataIsIncomplete()){
          RD.showProgress();
          RD.getData(RD.data.issues.length);
        } else {
          RD.findReleases();
          RD.listReleases();
        }
      }

      RD.dataIsIncomplete = function(){
        if(RD.data.issues.length + RD.data.startAt + 1 < RD.data.total){
          return true
        }
        return false;
      }

      RD.showProgress = function(){
        var progress = (RD.data.issues.length + RD.data.startAt + 1) / RD.data.total * 100;
        $("#loading-text .text").text('Loading ' + progress.toFixed(0) + '%');
      }

      RD.getData = function(startAtIndex){
        $.ajax({
          url: '/releases/' + startAtIndex,
          success: function(data){
            RD.data = data;
            RD.processData();
          }
        })
      }

      RD.listReleases = function(){
        $(RD.releases).each(function(index, release){
          var title = $(document.createElement('h2'));
          title.addClass('release-name');
          title.html("<a href='/show_release/" + release.key + "' target='__rdashboard'/>");
          title.children().first().text(release.fields.summary + ' - ' + release.fields.status.name);
          $('#container').append(title);

          var table = $('#status-template').clone().children().first();
          $('#container').append(table);

          var subTasks = release.fields.subtasks
          var numColumns = $($(table.children()[0]).children()[0]).children().length;
          var activityCells = $($(table.children()[0]).children()[0]).children();
          var assigneeCells = $($(table.children()[0]).children()[1]).children();
          var targetDateCells = $($(table.children()[0]).children()[2]).children();
          var statusCells = $($(table.children()[0]).children()[3]).children();

          for(var i = 1; i < numColumns; i++){
            var subtask = RD.issues[subTasks[i-1].key];
            $(activityCells[i]).text(subtask.fields.summary);
            $(statusCells[i]).text(subtask.fields.status.name);
            $(statusCells[i]).addClass(RD.cssify(subtask.fields.status.name));
            $(assigneeCells[i]).text(subtask.fields.assignee.displayName);
            $(targetDateCells[i]).text(subtask.fields.duedate);
          }
        });
      }

      $('#container').ajaxStart(function() {
        $(this).addClass('loading');
      });

      $('#container').ajaxStop(function() {
        $(this).removeClass('loading');
      });

      RD.getData(0);
    </script>
  </body>
</html>